- name: Configure routers
  hosts: routers
  gather_facts: no

  tasks:
    # --- Enable CDP globally on all routers ---
    - name: Enable CDP globally
      ios_config:
        lines:
          - cdp run

    # --- Router configs ---
    - name: Configure R1 interfaces
      ios_config:
        lines:
          - ip address 10.0.12.1 255.255.255.252
          - no shutdown
          - cdp enable
        parents: interface g1
      when: inventory_hostname == "R1"

    - name: Configure R1 second interface
      ios_config:
        lines:
          - ip address 10.0.13.1 255.255.255.252
          - no shutdown
          - cdp enable
        parents: interface g2
      when: inventory_hostname == "R1"

    - name: Configure R1 OSPF
      ios_config:
        lines:
          - network 10.0.12.0 0.0.0.3 area 0
          - network 10.0.13.0 0.0.0.3 area 0
        parents: router ospf 1
      when: inventory_hostname == "R1"

    - name: Configure R2 interfaces
      ios_config:
        lines:
          - ip address 10.0.12.2 255.255.255.252
          - no shutdown
          - cdp enable
        parents: interface g1
      when: inventory_hostname == "R2"

    - name: Configure R2 second interface
      ios_config:
        lines:
          - ip address 10.0.23.1 255.255.255.252
          - no shutdown
          - cdp enable
        parents: interface g3
      when: inventory_hostname == "R2"

    - name: Configure R2 OSPF
      ios_config:
        lines:
          - network 10.0.12.0 0.0.0.3 area 0
          - network 10.0.23.0 0.0.0.3 area 0
        parents: router ospf 1
      when: inventory_hostname == "R2"

    - name: Configure R3 interfaces
      ios_config:
        lines:
          - ip address 10.0.23.2 255.255.255.252
          - no shutdown
          - cdp enable
        parents: interface g3
      when: inventory_hostname == "R3"

    - name: Configure R3 second interface
      ios_config:
        lines:
          - ip address 10.0.13.2 255.255.255.252
          - no shutdown
          - cdp enable
        parents: interface g2
      when: inventory_hostname == "R3"

    - name: Configure R3 OSPF
      ios_config:
        lines:
          - network 10.0.13.0 0.0.0.3 area 0
          - network 10.0.23.0 0.0.0.3 area 0
        parents: router ospf 1
      when: inventory_hostname == "R3"

    # --- CDP neighbor parsing and descriptions ---
    - name: Gather CDP neighbors (table only)
      ios_command:
        commands:
          - show cdp neighbors | begin Device ID
      register: cdp_output

    - name: Split CDP output into lines
      set_fact:
        cdp_lines: "{{ cdp_output.stdout[0].splitlines() }}"

    - name: Filter valid CDP lines (skip headers/footers)
      set_fact:
        neighbor_lines: "{{ cdp_lines | select('match','^\\S+\\.cisco\\.com') | list }}"

    - name: Debug filtered CDP lines
      debug:
        var: neighbor_lines

    - name: Parse CDP neighbors by splitting and recombining
      set_fact:
        neighbors: "{{ neighbors | default([]) + [[ item.split()[0], (item.split()[1] ~ item.split()[2]), (item.split()[-2] ~ item.split()[-1]) ]] }}"
      loop: "{{ neighbor_lines }}"

    - name: Debug parsed neighbors
      debug:
        var: neighbors

    - name: Apply interface descriptions based on CDP
      ios_config:
        lines:
          - description // {{ item.0 | regex_replace('\\.cisco\\.com','') }} - {{ item.2 }} //
        parents: interface {{ item.1 }}
      loop: "{{ neighbors }}"
      when: neighbors | length > 0
