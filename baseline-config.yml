- name: Configure routers
  hosts: routers
  gather_facts: no

  tasks:
    # --- Enable CDP globally on all routers ---
    - name: Enable CDP globally
      ios_config:
        lines:
          - cdp run

    # --- Router configs ---
    - name: Configure R1 interfaces
      ios_config:
        lines:
          - ip address 10.0.12.1 255.255.255.252
          - no shutdown
          - cdp enable
        parents: interface g1
      when: inventory_hostname == "R1"

    - name: Configure R1 second interface
      ios_config:
        lines:
          - ip address 10.0.13.1 255.255.255.252
          - no shutdown
          - cdp enable
        parents: interface g2
      when: inventory_hostname == "R1"

    - name: Configure R1 OSPF
      ios_config:
        lines:
          - network 10.0.12.0 0.0.0.3 area 0
          - network 10.0.13.0 0.0.0.3 area 0
        parents: router ospf 1
      when: inventory_hostname == "R1"

    - name: Configure R2 interfaces
      ios_config:
        lines:
          - ip address 10.0.12.2 255.255.255.252
          - no shutdown
          - cdp enable
        parents: interface g1
      when: inventory_hostname == "R2"

    - name: Configure R2 second interface
      ios_config:
        lines:
          - ip address 10.0.23.1 255.255.255.252
          - no shutdown
          - cdp enable
        parents: interface g3
      when: inventory_hostname == "R2"

    - name: Configure R2 OSPF
      ios_config:
        lines:
          - network 10.0.12.0 0.0.0.3 area 0
          - network 10.0.23.0 0.0.0.3 area 0
        parents: router ospf 1
      when: inventory_hostname == "R2"

    - name: Configure R3 interfaces
      ios_config:
        lines:
          - ip address 10.0.23.2 255.255.255.252
          - no shutdown
          - cdp enable
        parents: interface g3
      when: inventory_hostname == "R3"

    - name: Configure R3 second interface
      ios_config:
        lines:
          - ip address 10.0.13.2 255.255.255.252
          - no shutdown
          - cdp enable
        parents: interface g2
      when: inventory_hostname == "R3"

    - name: Configure R3 OSPF
      ios_config:
        lines:
          - network 10.0.13.0 0.0.0.3 area 0
          - network 10.0.23.0 0.0.0.3 area 0
        parents: router ospf 1
      when: inventory_hostname == "R3"

    # --- CDP neighbor parsing and descriptions ---
    - name: Gather CDP neighbors
      ios_command:
        commands:
          - show cdp neighbors
      register: cdp_output

    - name: Debug raw CDP output
      debug:
        var: cdp_output.stdout[0]

    - name: Parse CDP neighbors (table format)
      set_fact:
        neighbors: "{{ cdp_output.stdout[0] | regex_findall('^(\\S+)\\s+(Gig\\s+\\d+)\\s+\\d+\\s+\\S+\\s+\\S+\\s+(Gig\\s+\\d+)', multiline=True) }}"

    - name: Debug parsed neighbors
      debug:
        var: neighbors

    - name: Apply interface descriptions based on CDP
      ios_config:
        lines:
          - description // {{ item.0 | regex_replace('\\.cisco\\.com','') }} - {{ item.2 | regex_replace(' ','') }} //
        parents: interface {{ item.1 | regex_replace(' ','') }}
      loop: "{{ neighbors }}"
      when: neighbors | length > 0
